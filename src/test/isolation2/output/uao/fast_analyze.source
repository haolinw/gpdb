--
-- Test AO/CO Fast Analyze Feature
--
-- This is intended to guard fast analyze function to work
-- with multi-segfiles tables under concurrent inserts.
--

create table analyze_@amname@ (id int, a int, b inet, c inet) using @amname@ with (compresstype=zlib, compresslevel=3);
CREATE

insert into analyze_@amname@ select 2, i, (select ((i%255)::text || '.' || (i%255)::text || '.' || (i%255)::text || '.' || (i%255)::text))::inet, (select ((i%255)::text || '.' || (i%255)::text || '.' || (i%255)::text || '.' || (i%255)::text))::inet from generate_series(1,30000)i;
INSERT 30000

insert into analyze_@amname@ select * from analyze_@amname@ limit 1000;
INSERT 1000
insert into analyze_@amname@ select * from analyze_@amname@ limit 1000;
INSERT 1000

-- test ANALYZE after concurrent inserts commit

1: begin;
BEGIN
1: insert into analyze_@amname@ select * from analyze_@amname@ limit 1000;
INSERT 1000

2: begin;
BEGIN
2: insert into analyze_@amname@ select * from analyze_@amname@ limit 1000;
INSERT 1000

3: begin;
BEGIN
3: insert into analyze_@amname@ select * from analyze_@amname@ limit 1000;
INSERT 1000

4: insert into analyze_@amname@ select * from analyze_@amname@ limit 1000;
INSERT 1000

5: analyze analyze_@amname@;
ANALYZE

1: commit;
COMMIT
2: commit;
COMMIT
3: abort;
ABORT

1: analyze analyze_@amname@;
ANALYZE

-- test aoblkdir based ANALYZE

create index on analyze_@amname@(id);
CREATE

1: begin;
BEGIN
1: insert into analyze_@amname@ select * from analyze_@amname@ limit 1000;
INSERT 1000

2: begin;
BEGIN
2: insert into analyze_@amname@ select * from analyze_@amname@ limit 1000;
INSERT 1000

3: begin;
BEGIN
3: insert into analyze_@amname@ select * from analyze_@amname@ limit 1000;
INSERT 1000

4: insert into analyze_@amname@ select * from analyze_@amname@ limit 1000;
INSERT 1000

5: analyze analyze_@amname@;
ANALYZE

1: commit;
COMMIT
2: commit;
COMMIT
3: abort;
ABORT

1: analyze analyze_@amname@;
ANALYZE

drop table analyze_@amname@;
DROP

-- test more data and stability, note, it could take a little long time

create table analyze_@amname@_2 (id int, a int, b inet, c inet) using @amname@ with (compresstype=zlib, compresslevel=3);
CREATE
insert into analyze_@amname@_2 select 2, i, (select ((i%255)::text || '.' || (i%255)::text || '.' || (i%255)::text || '.' || (i%255)::text))::inet, (select ((i%255)::text || '.' || (i%255)::text || '.' || (i%255)::text || '.' || (i%255)::text))::inet from generate_series(1,1000)i;
INSERT 1000

insert into analyze_@amname@_2 select * from analyze_@amname@_2;
INSERT 1000
insert into analyze_@amname@_2 select * from analyze_@amname@_2;
INSERT 2000
insert into analyze_@amname@_2 select * from analyze_@amname@_2;
INSERT 4000
insert into analyze_@amname@_2 select * from analyze_@amname@_2;
INSERT 8000
insert into analyze_@amname@_2 select * from analyze_@amname@_2;
INSERT 16000
insert into analyze_@amname@_2 select * from analyze_@amname@_2;
INSERT 32000
insert into analyze_@amname@_2 select * from analyze_@amname@_2;
INSERT 64000
insert into analyze_@amname@_2 select * from analyze_@amname@_2;
INSERT 128000

1: begin;
BEGIN
1: insert into analyze_@amname@_2 select * from analyze_@amname@_2;
INSERT 256000

2: insert into analyze_@amname@_2 select * from analyze_@amname@_2;
INSERT 256000

1: commit;
COMMIT

1: analyze analyze_@amname@_2;
ANALYZE
1: analyze analyze_@amname@_2;
ANALYZE
1: analyze analyze_@amname@_2;
ANALYZE
1: analyze analyze_@amname@_2;
ANALYZE
1: analyze analyze_@amname@_2;
ANALYZE

1: begin;
BEGIN
1: insert into analyze_@amname@_2 select * from analyze_@amname@_2;
INSERT 768000

2: insert into analyze_@amname@_2 select * from analyze_@amname@_2;
INSERT 768000

1: abort;
ABORT

1: analyze analyze_@amname@_2;
ANALYZE
1: analyze analyze_@amname@_2;
ANALYZE
1: analyze analyze_@amname@_2;
ANALYZE
1: analyze analyze_@amname@_2;
ANALYZE
1: analyze analyze_@amname@_2;
ANALYZE

-- test with aoblkdir

create index on analyze_@amname@_2(a);
CREATE

1: begin;
BEGIN
1: insert into analyze_@amname@_2 select * from analyze_@amname@_2;
INSERT 1536000

2: insert into analyze_@amname@_2 select * from analyze_@amname@_2;
INSERT 1536000

1: commit;
COMMIT

1: analyze analyze_@amname@_2;
ANALYZE
1: analyze analyze_@amname@_2;
ANALYZE
1: analyze analyze_@amname@_2;
ANALYZE
1: analyze analyze_@amname@_2;
ANALYZE
1: analyze analyze_@amname@_2;
ANALYZE

1: begin;
BEGIN
1: insert into analyze_@amname@_2 select * from analyze_@amname@_2;
INSERT 4608000

2: insert into analyze_@amname@_2 select * from analyze_@amname@_2;
INSERT 4608000

1: abort;
ABORT

1: analyze analyze_@amname@_2;
ANALYZE
1: analyze analyze_@amname@_2;
ANALYZE
1: analyze analyze_@amname@_2;
ANALYZE
1: analyze analyze_@amname@_2;
ANALYZE
1: analyze analyze_@amname@_2;
ANALYZE

drop table analyze_@amname@_2;
DROP
