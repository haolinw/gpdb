--
-- Test dead values returned in sampling CO tuples.
-- Non-blkdir based sampling had the following bug:
--
-- If you have 3 rows: (i,j) = (1, 1), (1, 2) and (1,3),
-- if (1, 2) is deleted, then we would return (1,1) and (1,2)
-- instead of (1,1) and (1,3) as visible.
--
-- This is because we missed advancing the datum streams for
-- non-first columns when the tuple was deleted.
--

-- partially same as Case 6 of tablesample.source
create table test_dead_values_return_@amname@(i int, j int, k int) using @amname@;
CREATE TABLE
insert into test_dead_values_return_@amname@ select 1, j, j from generate_series(1, 10) j;
INSERT 0 10
delete from test_dead_values_return_@amname@ where j % 2 = 0;
DELETE 5
select * from test_dead_values_return_@amname@;
 i | j | k 
---+---+---
 1 | 1 | 1 
 1 | 3 | 3 
 1 | 5 | 5 
 1 | 7 | 7 
 1 | 9 | 9 
(5 rows)
select * from gp_acquire_sample_rows('test_dead_values_return_@amname@'::regclass, 10000, 'f') as (totalrows pg_catalog.float8, totaldeadrows pg_catalog.float8, oversized_cols_length pg_catalog._float8, i int, j int, k int);
 totalrows | totaldeadrows | oversized_cols_length | i | j | k 
-----------+---------------+-----------------------+---+---+---
 0         | 0             |                       |   |   |   
 0         | 0             |                       |   |   |   
           |               |                       | 1 | 1 | 1 
           |               |                       | 1 | 3 | 3 
           |               |                       | 1 | 5 | 5 
           |               |                       | 1 | 7 | 7 
           |               |                       | 1 | 9 | 9 
 5         | 5             |                       |   |   |   
(8 rows)

truncate test_dead_values_return_@amname@;
TRUNCATE TABLE

1: begin;
BEGIN
2: begin;
BEGIN

1: insert into test_dead_values_return_@amname@ select 2, j, j from generate_series(1, 10) j;
INSERT 0 10
2: insert into test_dead_values_return_@amname@ select 2, j, j from generate_series(11, 20) j;
INSERT 0 10

2: abort;
ROLLBACK
1: commit;
COMMIT

1: begin;
BEGIN
2: begin;
BEGIN

1: insert into test_dead_values_return_@amname@ select 2, j, j from generate_series(21, 30) j;
INSERT 0 10
2: insert into test_dead_values_return_@amname@ select 2, j, j from generate_series(31, 40) j;
INSERT 0 10
2: commit;
COMMIT

1: delete from test_dead_values_return_@amname@ where j % 2 = 1;
DELETE 15
1: commit;
COMMIT

select * from test_dead_values_return_@amname@;
 i | j  | k  
---+----+----
 2 | 2  | 2  
 2 | 4  | 4  
 2 | 6  | 6  
 2 | 8  | 8  
 2 | 10 | 10 
 2 | 32 | 32 
 2 | 34 | 34 
 2 | 36 | 36 
 2 | 38 | 38 
 2 | 40 | 40 
 2 | 22 | 22 
 2 | 24 | 24 
 2 | 26 | 26 
 2 | 28 | 28 
 2 | 30 | 30 
(15 rows)
select * from gp_acquire_sample_rows('test_dead_values_return_@amname@'::regclass, 10000, 'f') as (totalrows pg_catalog.float8, totaldeadrows pg_catalog.float8, oversized_cols_length pg_catalog._float8, i int, j int, k int);
 totalrows | totaldeadrows | oversized_cols_length | i | j  | k  
-----------+---------------+-----------------------+---+----+----
 0         | 0             |                       |   |    |    
 0         | 0             |                       |   |    |    
           |               |                       | 2 | 2  | 2  
           |               |                       | 2 | 4  | 4  
           |               |                       | 2 | 6  | 6  
           |               |                       | 2 | 8  | 8  
           |               |                       | 2 | 10 | 10 
           |               |                       | 2 | 32 | 32 
           |               |                       | 2 | 34 | 34 
           |               |                       | 2 | 36 | 36 
           |               |                       | 2 | 38 | 38 
           |               |                       | 2 | 40 | 40 
           |               |                       | 2 | 22 | 22 
           |               |                       | 2 | 24 | 24 
           |               |                       | 2 | 26 | 26 
           |               |                       | 2 | 28 | 28 
           |               |                       | 2 | 30 | 30 
 15        | 15            |                       |   |    |    
(18 rows)

drop table test_dead_values_return_@amname@;
DROP TABLE
