--
-- Test dead values returned in sampling CO tuples.
-- Non-blkdir based sampling had the following bug:
--
-- If you have 3 rows: (i,j) = (1, 1), (1, 2) and (1,3),
-- if (1, 2) is deleted, then we would return (1,1) and (1,2)
-- instead of (1,1) and (1,3) as visible.
--
-- This is because we missed advancing the datum streams for
-- non-first columns when the tuple was deleted.
--

-- partially same as Case 6 of tablesample.source
create table test_dead_values_return_@amname@(i int, j int, k text, l text) using @amname@;
CREATE TABLE
insert into test_dead_values_return_@amname@ select 1, j, repeat('k', j), repeat('l', j) from generate_series(1, 10) j;
INSERT 0 10
delete from test_dead_values_return_@amname@ where j % 2 = 0;
DELETE 5
select * from test_dead_values_return_@amname@;
 i | j | k         | l         
---+---+-----------+-----------
 1 | 1 | k         | l         
 1 | 3 | kkk       | lll       
 1 | 5 | kkkkk     | lllll     
 1 | 7 | kkkkkkk   | lllllll   
 1 | 9 | kkkkkkkkk | lllllllll 
(5 rows)
select * from gp_acquire_sample_rows('test_dead_values_return_@amname@'::regclass, 10000, 'f') as (totalrows pg_catalog.float8, totaldeadrows pg_catalog.float8, oversized_cols_length pg_catalog._float8, i int, j int, k text, l text);
 totalrows | totaldeadrows | oversized_cols_length | i | j | k   | l   
-----------+---------------+-----------------------+---+---+-----+-----
 0         | 0             |                       |   |   |     |     
 0         | 0             |                       |   |   |     |     
           |               |                       | 1 | 1 | k   | l   
           |               |                       | 1 | 2 | kk  | ll  
           |               |                       | 1 | 3 | kkk | lll 
 5         | 5             |                       |   |   |     |     
(6 rows)

truncate test_dead_values_return_@amname@;
TRUNCATE TABLE

1: begin;
BEGIN
2: begin;
BEGIN

1: insert into test_dead_values_return_@amname@ select 2, j, repeat('k', j), repeat('l', j) from generate_series(1, 10) j;
INSERT 0 10
2: insert into test_dead_values_return_@amname@ select 2, j, repeat('k', j), repeat('l', j) from generate_series(11, 20) j;
INSERT 0 10

2: abort;
ROLLBACK
1: commit;
COMMIT

1: begin;
BEGIN
2: begin;
BEGIN

1: insert into test_dead_values_return_@amname@ select 2, j, repeat('k', j), repeat('l', j) from generate_series(21, 30) j;
INSERT 0 10
2: insert into test_dead_values_return_@amname@ select 2, j, repeat('k', j), repeat('l', j) from generate_series(31, 40) j;
INSERT 0 10
2: commit;
COMMIT

1: delete from test_dead_values_return_@amname@ where j % 2 = 1;
DELETE 15
1: commit;
COMMIT

select * from test_dead_values_return_@amname@;
 i | j  | k                                        | l                                        
---+----+------------------------------------------+------------------------------------------
 2 | 2  | kk                                       | ll                                       
 2 | 4  | kkkk                                     | llll                                     
 2 | 6  | kkkkkk                                   | llllll                                   
 2 | 8  | kkkkkkkk                                 | llllllll                                 
 2 | 10 | kkkkkkkkkk                               | llllllllll                               
 2 | 32 | kkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkk         | llllllllllllllllllllllllllllllll         
 2 | 34 | kkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkk       | llllllllllllllllllllllllllllllllll       
 2 | 36 | kkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkk     | llllllllllllllllllllllllllllllllllll     
 2 | 38 | kkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkk   | llllllllllllllllllllllllllllllllllllll   
 2 | 40 | kkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkk | llllllllllllllllllllllllllllllllllllllll 
 2 | 22 | kkkkkkkkkkkkkkkkkkkkkk                   | llllllllllllllllllllll                   
 2 | 24 | kkkkkkkkkkkkkkkkkkkkkkkk                 | llllllllllllllllllllllll                 
 2 | 26 | kkkkkkkkkkkkkkkkkkkkkkkkkk               | llllllllllllllllllllllllll               
 2 | 28 | kkkkkkkkkkkkkkkkkkkkkkkkkkkk             | llllllllllllllllllllllllllll             
 2 | 30 | kkkkkkkkkkkkkkkkkkkkkkkkkkkkkk           | llllllllllllllllllllllllllllll           
(15 rows)
select * from gp_acquire_sample_rows('test_dead_values_return_@amname@'::regclass, 10000, 'f') as (totalrows pg_catalog.float8, totaldeadrows pg_catalog.float8, oversized_cols_length pg_catalog._float8, i int, j int, k text, l text);
 totalrows | totaldeadrows | oversized_cols_length | i | j | k       | l       
-----------+---------------+-----------------------+---+---+---------+---------
 0         | 0             |                       |   |   |         |         
 0         | 0             |                       |   |   |         |         
           |               |                       | 2 | 1 | k       | l       
           |               |                       | 2 | 2 | kk      | ll      
           |               |                       | 2 | 3 | kkk     | lll     
           |               |                       | 2 | 4 | kkkk    | llll    
           |               |                       | 2 | 5 | kkkkk   | lllll   
           |               |                       | 2 | 6 | kkkkkk  | llllll  
           |               |                       | 2 | 7 | kkkkkkk | lllllll 
 15        | 15            |                       |   |   |         |         
(10 rows)

drop table test_dead_values_return_@amname@;
DROP TABLE
