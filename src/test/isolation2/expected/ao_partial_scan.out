CREATE EXTENSION pageinspect;
CREATE

--------------------------------------------------------------------------------
----                            ao_row tables
--------------------------------------------------------------------------------

CREATE TABLE ao_partial_scan1(i int, j int) USING ao_row;
CREATE

--------------------------------------------------------------------------------
-- Scenario 1: Starting block number of scans map to block directory entries,
-- across multiple minipages, corresponding to multiple segfiles.
--------------------------------------------------------------------------------

-- Create a couple of seg files, spanning a couple of minipages each.
1: BEGIN;
BEGIN
2: BEGIN;
BEGIN
1: INSERT INTO ao_partial_scan1 SELECT 1,j FROM generate_series(1, 300000) j;
INSERT 300000
2: INSERT INTO ao_partial_scan1 SELECT 20,j FROM generate_series(1, 300000) j;
INSERT 300000
1: COMMIT;
COMMIT
2: COMMIT;
COMMIT

-- Doing an index build will result in scanning the relation whole.
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
CREATE INDEX ON ao_partial_scan1 USING brin(i) WITH (pages_per_range = 3);
CREATE
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                     
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'332' 
 
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

-- Show the composition of the single data page in the BRIN index.
1U: SELECT * FROM brin_page_items(get_raw_page('ao_partial_scan1_i_idx', 2), 'ao_partial_scan1_i_idx');
 itemoffset | blknum   | attnum | allnulls | hasnulls | placeholder | value      
------------+----------+--------+----------+----------+-------------+------------
 1          | 33554432 | 1      | f        | f        | f           | {1 .. 1}   
 2          | 33554435 | 1      | f        | f        | f           | {1 .. 1}   
 3          | 33554438 | 1      | f        | f        | f           | {1 .. 1}   
 4          | 33554441 | 1      | f        | f        | f           | {1 .. 1}   
 5          | 67108864 | 1      | f        | f        | f           | {20 .. 20} 
 6          | 67108867 | 1      | f        | f        | f           | {20 .. 20} 
 7          | 67108870 | 1      | f        | f        | f           | {20 .. 20} 
 8          | 67108873 | 1      | f        | f        | f           | {20 .. 20} 
(8 rows)

-- Now desummarize a few ranges.
1U: SELECT brin_desummarize_range('ao_partial_scan1_i_idx', 33554432);
 brin_desummarize_range 
------------------------
                        
(1 row)
1U: SELECT brin_desummarize_range('ao_partial_scan1_i_idx', 33554438);
 brin_desummarize_range 
------------------------
                        
(1 row)
1U: SELECT brin_desummarize_range('ao_partial_scan1_i_idx', 33554441);
 brin_desummarize_range 
------------------------
                        
(1 row)
1U: SELECT brin_desummarize_range('ao_partial_scan1_i_idx', 67108867);
 brin_desummarize_range 
------------------------
                        
(1 row)

-- Now summarize these desummarized ranges piecemeal and check that we scan only
-- a subset of the blocks each time.
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
SELECT brin_summarize_range('ao_partial_scan1_i_idx', 33554432);
 brin_summarize_range 
----------------------
 1                    
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                    
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'55' 
 
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
SELECT brin_summarize_range('ao_partial_scan1_i_idx', 33554438);
 brin_summarize_range 
----------------------
 1                    
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                    
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'55' 
 
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
SELECT brin_summarize_range('ao_partial_scan1_i_idx', 33554441);
 brin_summarize_range 
----------------------
 1                    
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                   
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'5' 
 
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
SELECT brin_summarize_range('ao_partial_scan1_i_idx', 67108867);
 brin_summarize_range 
----------------------
 1                    
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                    
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'55' 
 
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

-- Sanity: the summary info is reflected in the data page.
1U: SELECT * FROM brin_page_items(get_raw_page('ao_partial_scan1_i_idx', 2), 'ao_partial_scan1_i_idx');
 itemoffset | blknum   | attnum | allnulls | hasnulls | placeholder | value      
------------+----------+--------+----------+----------+-------------+------------
 1          |          |        |          |          |             |            
 2          | 33554435 | 1      | f        | f        | f           | {1 .. 1}   
 3          |          |        |          |          |             |            
 4          |          |        |          |          |             |            
 5          | 67108864 | 1      | f        | f        | f           | {20 .. 20} 
 6          |          |        |          |          |             |            
 7          | 67108870 | 1      | f        | f        | f           | {20 .. 20} 
 8          | 67108873 | 1      | f        | f        | f           | {20 .. 20} 
 9          | 33554432 | 1      | f        | f        | f           | {1 .. 1}   
 10         | 33554438 | 1      | f        | f        | f           | {1 .. 1}   
 11         | 33554441 | 1      | f        | f        | f           | {1 .. 1}   
 12         | 67108867 | 1      | f        | f        | f           | {20 .. 20} 
(12 rows)

--------------------------------------------------------------------------------
-- Scenario 2: Starting block number of scan maps to hole at the end of the
-- minipage (after the last entry).
--------------------------------------------------------------------------------
CREATE TABLE ao_partial_scan2(i int, j int) USING ao_row;
CREATE
-- Fill 1 logical heap block with committed rows.
INSERT INTO ao_partial_scan2 SELECT 1, j FROM generate_series(1, 32767) j;
INSERT 32767
-- Now add some aborted rows at the end of the segfile, resulting in a hole at
-- the end of the minipage.
BEGIN;
BEGIN
INSERT INTO ao_partial_scan2 SELECT 20, j FROM generate_series(1, 32767) j;
INSERT 32767
ABORT;
ABORT

-- Doing an index build will result in scanning the committed rows only.
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
CREATE INDEX ON ao_partial_scan2 USING brin(i) WITH (pages_per_range = 1);
CREATE
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                    
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'19' 
 
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

-- Show the composition of the single data page in the BRIN index.
1U: SELECT * FROM brin_page_items(get_raw_page('ao_partial_scan2_i_idx', 2), 'ao_partial_scan2_i_idx');
 itemoffset | blknum   | attnum | allnulls | hasnulls | placeholder | value    
------------+----------+--------+----------+----------+-------------+----------
 1          | 33554432 | 1      | f        | f        | f           | {1 .. 1} 
(1 row)

-- Now desummarize the first range of committed rows.
1U: SELECT brin_desummarize_range('ao_partial_scan2_i_idx', 33554432);
 brin_desummarize_range 
------------------------
                        
(1 row)

-- Summarizing the first range now should only scan the committed rows. (same
-- as the index build)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
SELECT brin_summarize_range('ao_partial_scan2_i_idx', 33554432);
 brin_summarize_range 
----------------------
 1                    
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                    
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'19' 
 
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

-- Since we fell into a hole (at the end of the segfile), we skip ahead to the
-- offset of the last block directory entry before the hole. We end up scanning
-- just the 1 block as a result.
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
SELECT brin_summarize_range('ao_partial_scan2_i_idx', 33554433);
 brin_summarize_range 
----------------------
 1                    
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                   
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'1' 
 
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

-- Sanity: the summary info is reflected in the data page.
1U: SELECT * FROM brin_page_items(get_raw_page('ao_partial_scan2_i_idx', 2), 'ao_partial_scan2_i_idx');
 itemoffset | blknum   | attnum | allnulls | hasnulls | placeholder | value    
------------+----------+--------+----------+----------+-------------+----------
 1          | 33554432 | 1      | f        | f        | f           | {1 .. 1} 
 2          | 33554433 | 1      | t        | f        | f           |          
(2 rows)

--------------------------------------------------------------------------------
-- Scenario 3: Starting block number of scan maps to hole at the start of the
-- segfile (and before the first entry of the first minipage).
--------------------------------------------------------------------------------
CREATE TABLE ao_partial_scan3(i int, j int) USING ao_row;
CREATE
-- Now add some aborted rows at the end of the segfile, resulting in a hole at
-- the end of the minipage.
BEGIN;
BEGIN
INSERT INTO ao_partial_scan3 SELECT 1, j FROM generate_series(1, 32767) j;
INSERT 32767
ABORT;
ABORT
-- Fill 3 logical heap blocks with committed rows.
INSERT INTO ao_partial_scan3 SELECT 20, j FROM generate_series(1, 32767 * 3) j;
INSERT 98301

-- Doing an index build will result in scanning the committed rows only.
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
CREATE INDEX ON ao_partial_scan3 USING brin(i) WITH (pages_per_range = 3);
CREATE
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                    
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'55' 
 
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

-- Show the composition of the single data page in the BRIN index.
1U: SELECT * FROM brin_page_items(get_raw_page('ao_partial_scan3_i_idx', 2), 'ao_partial_scan3_i_idx');
 itemoffset | blknum   | attnum | allnulls | hasnulls | placeholder | value      
------------+----------+--------+----------+----------+-------------+------------
 1          | 33554432 | 1      | f        | f        | f           | {20 .. 20} 
 2          | 33554435 | 1      | f        | f        | f           | {20 .. 20} 
(2 rows)

-- Now desummarize the range with 1 block of aborted rows and 2 blocks of
-- committed rows.
1U: SELECT brin_desummarize_range('ao_partial_scan3_i_idx', 33554432);
 brin_desummarize_range 
------------------------
                        
(1 row)

-- Summarizing this range should scan blocks corresponding to the 2 final logical
-- heap blocks in the range only.
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
SELECT gp_inject_fault('AppendOnlyBlockDirectory_PartialScan_hole_at_start', 'skip', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
SELECT brin_summarize_range('ao_partial_scan3_i_idx', 33554432);
 brin_summarize_range 
----------------------
 1                    
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                    
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'37' 
 
(1 row)
SELECT gp_wait_until_triggered_fault('AppendOnlyBlockDirectory_PartialScan_hole_at_start', 1, dbid) FROM gp_segment_configuration where role='p' and content = 1;
 gp_wait_until_triggered_fault 
-------------------------------
 Success:                      
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
SELECT gp_inject_fault('AppendOnlyBlockDirectory_PartialScan_hole_at_start', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

-- Sanity: the summary info is reflected in the data page.
1U: SELECT * FROM brin_page_items(get_raw_page('ao_partial_scan3_i_idx', 2), 'ao_partial_scan3_i_idx');
 itemoffset | blknum   | attnum | allnulls | hasnulls | placeholder | value      
------------+----------+--------+----------+----------+-------------+------------
 1          |          |        |          |          |             |            
 2          | 33554435 | 1      | f        | f        | f           | {20 .. 20} 
 3          | 33554432 | 1      | f        | f        | f           | {20 .. 20} 
(3 rows)

--------------------------------------------------------------------------------
-- Scenario 4: Starting block number of scan maps to hole between two entries
-- in a minipage.
--------------------------------------------------------------------------------

CREATE TABLE ao_partial_scan4(i int, j int) USING ao_row;
CREATE

-- Using populate_pages creates holes due to the nature of its piecemeal inserts
-- of 1 row. So, each blkdir entry will have 1 row each. Populate 3 blocks this
-- way, 2 blocks full and 1 block with 1 tuple.
SELECT populate_pages('ao_partial_scan4', 1, tid '(33554434, 0)');
 populate_pages 
----------------
                
(1 row)

-- Doing an index build will result in scanning the whole relation.
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
CREATE INDEX ON ao_partial_scan4 USING brin(i) WITH (pages_per_range = 1);
CREATE
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                     
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'657' 
 
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

-- Show the composition of the single data page in the BRIN index.
1U: SELECT * FROM brin_page_items(get_raw_page('ao_partial_scan4_i_idx', 2), 'ao_partial_scan4_i_idx');
 itemoffset | blknum   | attnum | allnulls | hasnulls | placeholder | value    
------------+----------+--------+----------+----------+-------------+----------
 1          | 33554432 | 1      | f        | f        | f           | {1 .. 1} 
 2          | 33554433 | 1      | f        | f        | f           | {1 .. 1} 
 3          | 33554434 | 1      | f        | f        | f           | {1 .. 1} 
(3 rows)

-- Now desummarize a range.
1U: SELECT brin_desummarize_range('ao_partial_scan4_i_idx', 33554433);
 brin_desummarize_range 
------------------------
                        
(1 row)

-- Summarizing it will map to a hole between block directory entries, so we will
-- start our scan from the entry preceding the hole.
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
SELECT brin_summarize_range('ao_partial_scan4_i_idx', 33554433);
 brin_summarize_range 
----------------------
 1                    
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                     
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'330' 
 
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

-- Sanity: the summary info is reflected in the data page.
1U: SELECT * FROM brin_page_items(get_raw_page('ao_partial_scan4_i_idx', 2), 'ao_partial_scan4_i_idx');
 itemoffset | blknum   | attnum | allnulls | hasnulls | placeholder | value    
------------+----------+--------+----------+----------+-------------+----------
 1          | 33554432 | 1      | f        | f        | f           | {1 .. 1} 
 2          |          |        |          |          |             |          
 3          | 33554434 | 1      | f        | f        | f           | {1 .. 1} 
 4          | 33554433 | 1      | f        | f        | f           | {1 .. 1} 
(4 rows)

--------------------------------------------------------------------------------
----                          ao_column tables
--------------------------------------------------------------------------------

CREATE TABLE aoco_partial_scan1(i int, j int, k int) USING ao_column;
CREATE

--------------------------------------------------------------------------------
-- Scenario 1: Starting block number of scans map to block directory entries,
-- across multiple minipages, corresponding to multiple segfiles.
--------------------------------------------------------------------------------

-- Create a couple of seg files, spanning a couple of minipages each.
1: BEGIN;
BEGIN
2: BEGIN;
BEGIN
1: INSERT INTO aoco_partial_scan1 SELECT 1,100,k FROM generate_series(1, 300000) k;
INSERT 300000
2: INSERT INTO aoco_partial_scan1 SELECT 20,200,k FROM generate_series(1, 300000) k;
INSERT 300000
1: COMMIT;
COMMIT
2: COMMIT;
COMMIT

-- Doing an index build will result in scanning the relation whole.
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
CREATE INDEX ON aoco_partial_scan1 USING brin(i, j) WITH (pages_per_range = 3);
CREATE
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                     
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'222' 
 
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

-- Show the composition of the single data page in the BRIN index.
1U: SELECT * FROM brin_page_items(get_raw_page('aoco_partial_scan1_i_j_idx', 2), 'aoco_partial_scan1_i_j_idx');
 itemoffset | blknum   | attnum | allnulls | hasnulls | placeholder | value        
------------+----------+--------+----------+----------+-------------+--------------
 1          | 33554432 | 1      | f        | f        | f           | {1 .. 1}     
 1          | 33554432 | 2      | f        | f        | f           | {100 .. 100} 
 2          | 33554435 | 1      | f        | f        | f           | {1 .. 1}     
 2          | 33554435 | 2      | f        | f        | f           | {100 .. 100} 
 3          | 33554438 | 1      | f        | f        | f           | {1 .. 1}     
 3          | 33554438 | 2      | f        | f        | f           | {100 .. 100} 
 4          | 33554441 | 1      | f        | f        | f           | {1 .. 1}     
 4          | 33554441 | 2      | f        | f        | f           | {100 .. 100} 
 5          | 67108864 | 1      | f        | f        | f           | {20 .. 20}   
 5          | 67108864 | 2      | f        | f        | f           | {200 .. 200} 
 6          | 67108867 | 1      | f        | f        | f           | {20 .. 20}   
 6          | 67108867 | 2      | f        | f        | f           | {200 .. 200} 
 7          | 67108870 | 1      | f        | f        | f           | {20 .. 20}   
 7          | 67108870 | 2      | f        | f        | f           | {200 .. 200} 
 8          | 67108873 | 1      | f        | f        | f           | {20 .. 20}   
 8          | 67108873 | 2      | f        | f        | f           | {200 .. 200} 
(16 rows)

-- Now desummarize a few ranges.
1U: SELECT brin_desummarize_range('aoco_partial_scan1_i_j_idx', 33554432);
 brin_desummarize_range 
------------------------
                        
(1 row)
1U: SELECT brin_desummarize_range('aoco_partial_scan1_i_j_idx', 33554438);
 brin_desummarize_range 
------------------------
                        
(1 row)
1U: SELECT brin_desummarize_range('aoco_partial_scan1_i_j_idx', 33554441);
 brin_desummarize_range 
------------------------
                        
(1 row)
1U: SELECT brin_desummarize_range('aoco_partial_scan1_i_j_idx', 67108867);
 brin_desummarize_range 
------------------------
                        
(1 row)

-- Now summarize these desummarized ranges piecemeal and check that we scan only
-- a subset of the blocks each time.
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
SELECT brin_summarize_range('aoco_partial_scan1_i_j_idx', 33554432);
 brin_summarize_range 
----------------------
 1                    
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                    
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'28' 
 
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
SELECT brin_summarize_range('aoco_partial_scan1_i_j_idx', 33554438);
 brin_summarize_range 
----------------------
 1                    
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                    
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'28' 
 
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
SELECT brin_summarize_range('aoco_partial_scan1_i_j_idx', 33554441);
 brin_summarize_range 
----------------------
 1                    
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                   
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'6' 
 
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
SELECT brin_summarize_range('aoco_partial_scan1_i_j_idx', 67108867);
 brin_summarize_range 
----------------------
 1                    
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                    
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'28' 
 
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

-- Sanity: the summary info is reflected in the data page.
1U: SELECT * FROM brin_page_items(get_raw_page('aoco_partial_scan1_i_j_idx', 2), 'aoco_partial_scan1_i_j_idx');
 itemoffset | blknum   | attnum | allnulls | hasnulls | placeholder | value        
------------+----------+--------+----------+----------+-------------+--------------
 1          |          |        |          |          |             |              
 2          | 33554435 | 1      | f        | f        | f           | {1 .. 1}     
 2          | 33554435 | 2      | f        | f        | f           | {100 .. 100} 
 3          |          |        |          |          |             |              
 4          |          |        |          |          |             |              
 5          | 67108864 | 1      | f        | f        | f           | {20 .. 20}   
 5          | 67108864 | 2      | f        | f        | f           | {200 .. 200} 
 6          |          |        |          |          |             |              
 7          | 67108870 | 1      | f        | f        | f           | {20 .. 20}   
 7          | 67108870 | 2      | f        | f        | f           | {200 .. 200} 
 8          | 67108873 | 1      | f        | f        | f           | {20 .. 20}   
 8          | 67108873 | 2      | f        | f        | f           | {200 .. 200} 
 9          | 33554432 | 1      | f        | f        | f           | {1 .. 1}     
 9          | 33554432 | 2      | f        | f        | f           | {100 .. 100} 
 10         | 33554438 | 1      | f        | f        | f           | {1 .. 1}     
 10         | 33554438 | 2      | f        | f        | f           | {100 .. 100} 
 11         | 33554441 | 1      | f        | f        | f           | {1 .. 1}     
 11         | 33554441 | 2      | f        | f        | f           | {100 .. 100} 
 12         | 67108867 | 1      | f        | f        | f           | {20 .. 20}   
 12         | 67108867 | 2      | f        | f        | f           | {200 .. 200} 
(20 rows)

--------------------------------------------------------------------------------
-- Scenario 2: Starting block number of scan maps to hole at the end of the
-- minipage (after the last entry).
--------------------------------------------------------------------------------
CREATE TABLE aoco_partial_scan2(i int, j int, k int) USING ao_column;
CREATE
-- Fill 1 logical heap block with committed rows.
INSERT INTO aoco_partial_scan2 SELECT 1, 100, k FROM generate_series(1, 32767) k;
INSERT 32767
-- Now add some aborted rows at the end of the segfile, resulting in a hole at
-- the end of the minipage.
BEGIN;
BEGIN
INSERT INTO aoco_partial_scan2 SELECT 20, 200, k FROM generate_series(1, 32767) k;
INSERT 32767
ABORT;
ABORT

-- Doing an index build will result in scanning the committed rows only.
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
CREATE INDEX ON aoco_partial_scan2 USING brin(i, j) WITH (pages_per_range = 1);
CREATE
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                    
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'15' 
 
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

-- Show the composition of the single data page in the BRIN index.
1U: SELECT * FROM brin_page_items(get_raw_page('aoco_partial_scan2_i_j_idx', 2), 'aoco_partial_scan2_i_j_idx');
 itemoffset | blknum   | attnum | allnulls | hasnulls | placeholder | value        
------------+----------+--------+----------+----------+-------------+--------------
 1          | 33554432 | 1      | f        | f        | f           | {1 .. 1}     
 1          | 33554432 | 2      | f        | f        | f           | {100 .. 100} 
(2 rows)

-- Now desummarize the first range of committed rows.
1U: SELECT brin_desummarize_range('aoco_partial_scan2_i_j_idx', 33554432);
 brin_desummarize_range 
------------------------
                        
(1 row)

-- Summarizing the first range now should only scan the committed rows. (same
-- as the index build)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
SELECT brin_summarize_range('aoco_partial_scan2_i_j_idx', 33554432);
 brin_summarize_range 
----------------------
 1                    
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                    
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'12' 
 
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

-- Since we fell into a hole (at the end of the segfile), we skip ahead to the
-- offset of the last block directory entries before the hole.
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
SELECT brin_summarize_range('aoco_partial_scan2_i_j_idx', 33554433);
 brin_summarize_range 
----------------------
 1                    
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                   
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'4' 
 
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

-- Sanity: the summary info is reflected in the data page.
1U: SELECT * FROM brin_page_items(get_raw_page('aoco_partial_scan2_i_j_idx', 2), 'aoco_partial_scan2_i_j_idx');
 itemoffset | blknum   | attnum | allnulls | hasnulls | placeholder | value        
------------+----------+--------+----------+----------+-------------+--------------
 1          | 33554432 | 1      | f        | f        | f           | {1 .. 1}     
 1          | 33554432 | 2      | f        | f        | f           | {100 .. 100} 
 2          | 33554433 | 1      | t        | f        | f           |              
 2          | 33554433 | 2      | t        | f        | f           |              
(4 rows)

--------------------------------------------------------------------------------
-- Scenario 3: Starting block number of scan maps to hole at the start of the
-- segfile (and before the first entry of the first minipage).
--------------------------------------------------------------------------------
CREATE TABLE aoco_partial_scan3(i int, j int, k int) USING ao_column;
CREATE
-- Now add some aborted rows at the end of the segfile, resulting in a hole at
-- the end of the minipage.
BEGIN;
BEGIN
INSERT INTO aoco_partial_scan3 SELECT 1, 100, k FROM generate_series(1, 32767) k;
INSERT 32767
ABORT;
ABORT
-- Fill 3 logical heap blocks with committed rows.
INSERT INTO aoco_partial_scan3 SELECT 20, 100, k FROM generate_series(1, 32767 * 3) k;
INSERT 98301

-- Doing an index build will result in scanning the committed rows only.
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
CREATE INDEX ON aoco_partial_scan3 USING brin(i, j) WITH (pages_per_range = 3);
CREATE
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                    
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'39' 
 
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

-- Show the composition of the single data page in the BRIN index.
1U: SELECT * FROM brin_page_items(get_raw_page('aoco_partial_scan3_i_j_idx', 2), 'aoco_partial_scan3_i_j_idx');
 itemoffset | blknum   | attnum | allnulls | hasnulls | placeholder | value        
------------+----------+--------+----------+----------+-------------+--------------
 1          | 33554432 | 1      | f        | f        | f           | {20 .. 20}   
 1          | 33554432 | 2      | f        | f        | f           | {100 .. 100} 
 2          | 33554435 | 1      | f        | f        | f           | {20 .. 20}   
 2          | 33554435 | 2      | f        | f        | f           | {100 .. 100} 
(4 rows)

-- Now desummarize the range with 1 block of aborted rows and 2 blocks of
-- committed rows.
1U: SELECT brin_desummarize_range('aoco_partial_scan3_i_j_idx', 33554432);
 brin_desummarize_range 
------------------------
                        
(1 row)

-- Summarizing this range should scan blocks corresponding to the 2 final logical
-- heap blocks in the range only.
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
SELECT gp_inject_fault('AppendOnlyBlockDirectory_PartialScan_hole_at_start', 'skip', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
SELECT brin_summarize_range('aoco_partial_scan3_i_j_idx', 33554432);
 brin_summarize_range 
----------------------
 1                    
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                    
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'18' 
 
(1 row)
SELECT gp_wait_until_triggered_fault('AppendOnlyBlockDirectory_PartialScan_hole_at_start', 1, dbid) FROM gp_segment_configuration where role='p' and content = 1;
 gp_wait_until_triggered_fault 
-------------------------------
 Success:                      
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
SELECT gp_inject_fault('AppendOnlyBlockDirectory_PartialScan_hole_at_start', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

-- Sanity: the summary info is reflected in the data page.
1U: SELECT * FROM brin_page_items(get_raw_page('aoco_partial_scan3_i_j_idx', 2), 'aoco_partial_scan3_i_j_idx');
 itemoffset | blknum   | attnum | allnulls | hasnulls | placeholder | value        
------------+----------+--------+----------+----------+-------------+--------------
 1          |          |        |          |          |             |              
 2          | 33554435 | 1      | f        | f        | f           | {20 .. 20}   
 2          | 33554435 | 2      | f        | f        | f           | {100 .. 100} 
 3          | 33554432 | 1      | f        | f        | f           | {20 .. 20}   
 3          | 33554432 | 2      | f        | f        | f           | {100 .. 100} 
(5 rows)

--------------------------------------------------------------------------------
-- Scenario 4: Starting block number of scan maps to hole between two entries
-- in a minipage.
--------------------------------------------------------------------------------

CREATE TABLE aoco_partial_scan4(i int) USING ao_column;
CREATE

-- Using populate_pages creates holes due to the nature of its piecemeal inserts
-- of 1 row. So, each blkdir entry will have 1 row each. Populate 3 blocks this
-- way, 2 blocks full and 1 block with 1 tuple.
SELECT populate_pages('aoco_partial_scan4', 1, tid '(33554434, 0)');
 populate_pages 
----------------
                
(1 row)

-- Doing an index build will result in scanning the whole relation.
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
CREATE INDEX ON aoco_partial_scan4 USING brin(i) WITH (pages_per_range = 1);
CREATE
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                     
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'657' 
 
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

-- Show the composition of the single data page in the BRIN index.
1U: SELECT * FROM brin_page_items(get_raw_page('aoco_partial_scan4_i_idx', 2), 'aoco_partial_scan4_i_idx');
 itemoffset | blknum   | attnum | allnulls | hasnulls | placeholder | value    
------------+----------+--------+----------+----------+-------------+----------
 1          | 33554432 | 1      | f        | f        | f           | {1 .. 1} 
 2          | 33554433 | 1      | f        | f        | f           | {1 .. 1} 
 3          | 33554434 | 1      | f        | f        | f           | {1 .. 1} 
(3 rows)

-- Now desummarize a range.
1U: SELECT brin_desummarize_range('aoco_partial_scan4_i_idx', 33554433);
 brin_desummarize_range 
------------------------
                        
(1 row)

-- Summarizing it will map to a hole between block directory entries, so we will
-- start our scan from the entries preceding the hole.
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'skip', '', '', '', 1, -1, 0, dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)
SELECT brin_summarize_range('aoco_partial_scan4_i_idx', 33554433);
 brin_summarize_range 
----------------------
 1                    
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'status', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault                                                                                                                                                                                                                                     
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Success: fault name:'AppendOnlyStorageRead_ReadNextBlock_success' fault type:'skip' ddl statement:'' database name:'' table name:'' start occurrence:'1' end occurrence:'-1' extra arg:'0' fault injection state:'triggered'  num times hit:'331' 
 
(1 row)
SELECT gp_inject_fault('AppendOnlyStorageRead_ReadNextBlock_success', 'reset', dbid) FROM gp_segment_configuration WHERE content = 1 AND role = 'p';
 gp_inject_fault 
-----------------
 Success:        
(1 row)

-- Sanity: the summary info is reflected in the data page.
1U: SELECT * FROM brin_page_items(get_raw_page('aoco_partial_scan4_i_idx', 2), 'aoco_partial_scan4_i_idx');
 itemoffset | blknum   | attnum | allnulls | hasnulls | placeholder | value    
------------+----------+--------+----------+----------+-------------+----------
 1          | 33554432 | 1      | f        | f        | f           | {1 .. 1} 
 2          |          |        |          |          |             |          
 3          | 33554434 | 1      | f        | f        | f           | {1 .. 1} 
 4          | 33554433 | 1      | f        | f        | f           | {1 .. 1} 
(4 rows)

DROP EXTENSION pageinspect;
DROP
